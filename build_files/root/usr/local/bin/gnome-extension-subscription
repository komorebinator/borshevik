#!/usr/bin/env python3

import subprocess
import os
import sys
from pathlib import Path

BASE_DIR = Path.home() / ".local/share/gnome-extension-subscription"
VENV_DIR = BASE_DIR / "venv"
MARK_FILE = BASE_DIR / "installed.txt"
LIST_FILE = Path("/usr/share/gnome-extension-subscription/extensions.txt")

def ensure_venv():
    if not VENV_DIR.exists():
        print("üîß Creating venv and installing gext...")
        subprocess.run([sys.executable, "-m", "venv", str(VENV_DIR)], check=True)

    print("üîÑ Ensuring gnome-extensions-cli is up to date...")
    subprocess.run(
        [str(VENV_DIR / "bin/pip"), "install", "--upgrade", "--quiet", "gnome-extensions-cli"],
        check=True
    )

def ensure_paths():
    BASE_DIR.mkdir(parents=True, exist_ok=True)
    if not MARK_FILE.exists():
        MARK_FILE.touch()

def read_list(path):
    with open(path, "r") as f:
        return [line.strip() for line in f if line.strip()]

def is_installed(uuid):
    result = subprocess.run(
        [str(VENV_DIR / "bin/gext"), "list", "--no-color", "--enabled"],
        capture_output=True, text=True
    )
    return uuid in result.stdout

def was_previously_installed(uuid):
    with open(MARK_FILE, "r") as f:
        return uuid in f.read().splitlines()

def mark_installed(uuid):
    with open(MARK_FILE, "a") as f:
        f.write(f"{uuid}\n")

def install(uuid):
    print(f"‚¨áÔ∏è Installing {uuid}")
    subprocess.run([str(VENV_DIR / "bin/gext"), "install", "--no-color", uuid], check=True)
    subprocess.run([str(VENV_DIR / "bin/gext"), "enable", "--no-color", uuid], check=True)
    mark_installed(uuid)
    print(f"‚úÖ Installed {uuid}")

def main():
    ensure_venv()
    ensure_paths()
    uuids = read_list(LIST_FILE)
    for uuid in uuids:
        if was_previously_installed(uuid):
            continue
        if is_installed(uuid):
            continue
        try:
            install(uuid)
        except subprocess.CalledProcessError:
            print(f"‚ùå Failed to install {uuid}")

if __name__ == "__main__":
    main()
