name: Promote image to stable

on:
  workflow_dispatch:
    inputs:
      variant:
        required: true
        type: choice
        options: [borshevik, borshevik-nvidia]
      digest:
        required: true
        type: string

permissions:
  contents: read
  packages: write

jobs:
  promote:
    runs-on: ubuntu-24.04
    steps:
      - name: Validate digest
        shell: bash
        run: |
          set -euo pipefail
          d='${{ inputs.digest }}'
          [[ "$d" =~ ^sha256:[0-9a-f]{64}$ ]] || { echo "Bad digest: $d" >&2; exit 1; }

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Retag digest to stable
        shell: bash
        env:
          OWNER: ${{ github.repository_owner }}
          VARIANT: ${{ inputs.variant }}
          DIGEST: ${{ inputs.digest }}
        run: |
          set -euo pipefail
          src="ghcr.io/${OWNER}/${VARIANT}@${DIGEST}"
          dst="ghcr.io/${OWNER}/${VARIANT}:stable"

          echo "Promote:"
          echo "  $src"
          echo "   -> $dst"

          docker buildx imagetools create --tag "$dst" "$src"
